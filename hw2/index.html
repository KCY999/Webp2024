<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->
        <style>
            table { 
                font-family: Arial, Helvetica, sans-serif; 
                border-collapse: collapse; 
                width: 100%; 
              } 
              td, th { 
                border: 1px solid #ddd; 
                padding: 6px; 
              } 
              tr:nth-child(even){background-color: #f2f2f2;} 
              tr:hover {background-color: #ddd;} 
              th { 
                padding-top: 12px; 
                padding-bottom: 12px; 
                text-align: left; 
                background-color: #04AA6D; 
                color: white; 
              } 
              input{
                height:30px; 
                width:150px; 
                font-size: 20px;
                padding: 2px;
              }
              #showPage{
                margin: 10px;
              }
              button {
                padding: 5px;
                margin: 5px;
              }
        </style>
    </head> 
    <body>
                                    <!-- input keyword -->
        <h1>觀光景點 <input type="text" id="inkw"/></h1>
             
        <table id="tp" class="table table-striped table-hover">
            <tr>
                <th>名稱</th>
                <th>地點</th>
                <th>票價</th>
            </tr>
        </table>

        <span> 
            <button id="prePage">上一頁</button>
            <span id="showPage"></span>
            <button id="nextPage">下一頁</button>
        </span>
        

        <script>
            var default_dataset;  // 所有data(篩選前)
            var using_dataset // 使用中的dataset(可能有篩選過)
            var nowDataOrder = 0;  // 現在在第幾個data
            var table = document.getElementById("tp");
            var totalPage;  // 總頁數
            var nowPageOrder = 1;  // 現在頁數

            // XMLHttpRequest
            var openUrl = "https://cloud.culture.tw/frontsite/trans/SearchShowAction.do?method=doFindTypeJ&category=6";
            var xhr = new XMLHttpRequest();
            xhr.open('GET',openUrl,true);
            xhr.send();
            xhr.onreadystatechange = function(){
                if( this.readyState == 4 && this.status == 200 ){
                    default_dataset = JSON.parse(this.responseText); 
                    //console.log(default_dataset);

                    using_dataset = default_dataset;  // 初始化 using_dataset
                    
                    showData(default_dataset,nowDataOrder);
                    //console.log(default_dataset[0]);

                    totalPage = Math.ceil(default_dataset.length / 10) ;  // 初始化 total page
                    //console.log(totalPage); 
                    //console.log(default_dataset.length);
                    
                    nowPageShow();
                }
            }
                    
            // show rows datas (limit 10 rows)
            function showData(dataset,dataOrder){

                rmRow(); // remove all rows first

                if(dataset.length==0){
                    //console.log("showData(): break")
                    this.break;
                }

                let i;
                if( dataOrder+10 >= dataset.length ){
                    for(i=dataOrder;i<dataset.length;i++){
                        var row = table.insertRow(-1);
                        row.insertCell(0).innerHTML = dataset[i]['title'];
                        row.insertCell(1).innerHTML = dataset[i]['showInfo'][0]['location'];
                        row.insertCell(2).innerHTML = dataset[i]['showInfo'][0]['price'];
                        //console.log("add1");
                    }
                }else{
                    for(i=dataOrder;i<dataOrder+10;i++){
                        var row = table.insertRow(-1);
                        row.insertCell(0).innerHTML = dataset[i]['title'];
                        row.insertCell(1).innerHTML = dataset[i]['showInfo'][0]['location'];
                        row.insertCell(2).innerHTML = dataset[i]['showInfo'][0]['price'];
                        //console.log("add2");
                    }
                }     
            }

            // remove all rows 
            function rmRow(){
                // console.log(table.rows.length);
                let delNum = table.rows.length; // table.rows.length 做為要刪除的row數量，要先存下來。
                let i;                          // 因為在執行刪除迴圈時，table.rows.length這個數也會隨著row的數量減少而改變
                // 從最下面的row開始刪，可因避免row減少，而使row編號向下遞移的問題。
                for(i=delNum-1;i>=1;i--){  
                    var row = table.rows[i];
                    //console.log(row.parentNode); tbody(?)
                    //console.log(document.body.table == row.parentNode); fasle
                    row.parentNode.removeChild(row); // 在row的父節點中，刪除其中的子元素row (刪除row)
                    // console.log(table.rows.length); PROVE THAT: table.rows.length因刪除row而持續變化
                }
            }
            
            // next page button
            var nextPage = document.getElementById("nextPage");
            nextPage.addEventListener("click",function(){
                if(nowPageOrder == totalPage){
                    this.break;
                }
                else{
                    nowDataOrder += 10;
                    showData(using_dataset,nowDataOrder);
                    nowPageShow();
                }
            });
            
            // prePage
            var prePage = document.getElementById("prePage");
            prePage.addEventListener("click",function(){
                if(nowPageOrder==1){
                    this.break;
                }
                else{
                    nowDataOrder -= 10;
                    showData(using_dataset,nowDataOrder);
                    nowPageShow();
                }
            });


            // show page bar
            var showPage = document.getElementById("showPage");
            function nowPageShow(){
                nowPageOrder = 1 + nowDataOrder/10 ;
                totalPage = (using_dataset.length / 10) == 0 ? 1 : Math.ceil(using_dataset.length / 10) ;  // Notice the stitu that using_dataset == null.
                showPage.textContent = ` ${nowPageOrder}/${totalPage}頁 `;
            }; 


            // keyword search
            // 篩選可用：  text.indexOf("keyword") -> return 「keyword在array中的位置(數字))」  或   text.includes("keyword") -> 「keyword是否在array中(true/false)」
            var inkw = document.getElementById("inkw");
            // __PS: 亦可以直接在物件後面加 .onchange 去處理event
            // ____EX: inkw.onchange = function(){console.log(this.value);}
 
            inkw.addEventListener("change",function(){  // notice that: 在addEventListener中，要用"change"，不是"onchange"
                //console.log( "this.value= " + this.value );
                //console.log(typeof this.value);
                //console.log(default_dataset[0]['title'].indexOf(this.value));
                
                
                let kw = this.value; // key word  
                // PS:此處要先將kw的值(結果)存下來，才能在下面帶進.filter(function(data){})中，
                console.log( "kw= " + kw );
                
                
                nowDataOrder = 0;
                nowPageOrder = 1;
                

                if( kw === '' ){
                    using_dataset = default_dataset;
                    showData(using_dataset,nowDataOrder);
                    nowPageShow();
                }else{
                    // 篩選 .filter(function(item))
                    using_dataset = default_dataset.filter(function(data){
                    // something that kw is included    
                    let is_kwIncluded = data['title'].includes(kw) || data['showInfo'][0]['location'].includes(kw) || data['showInfo'][0]['price'].includes(kw) ;
                    // console.log(is_kwIncluded);
                    return is_kwIncluded ;
                    });                    
                    // console.log(using_dataset);
                    // console.log(typeof using_dataset);
                    showData(using_dataset,nowDataOrder);
                    nowPageShow();
                }
            });

        </script>
    </body>
</html>
